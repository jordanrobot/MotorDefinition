<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:CurveEditor.ViewModels"
             xmlns:lvc="using:LiveChartsCore.SkiaSharpView.Avalonia"
             xmlns:converters="using:CurveEditor.Converters"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="500"
             x:Class="CurveEditor.Views.ChartView"
             x:DataType="vm:ChartViewModel">
    
    <UserControl.Resources>
        <converters:SKColorToAvaloniaBrushConverter x:Key="ColorConverter"/>
        <converters:BooleanToDashArrayConverter x:Key="DashArrayConverter"/>
    </UserControl.Resources>
    
    <Design.DataContext>
        <vm:ChartViewModel/>
    </Design.DataContext>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <Grid Grid.Row="0">
            <Canvas x:Name="UnderlayCanvas"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch">
                <Image x:Name="UnderlayImage"
                       Stretch="Fill"
                       Opacity="0.45"
                       IsHitTestVisible="False"/>
            </Canvas>

            <!-- Chart -->
            <lvc:CartesianChart
                x:Name="TorqueChart"
                Grid.Row="0"
                Panel.ZIndex="1"
                Series="{Binding Series}"
                XAxes="{Binding XAxes}"
                YAxes="{Binding YAxes}"
                TooltipPosition="Top"
                ZoomMode="None"
                AnimationsSpeed="00:00:00.000">
                <lvc:CartesianChart.TooltipBackgroundPaint>
                    <lvc:SolidColorPaint Color="#F5F5F5" />
                </lvc:CartesianChart.TooltipBackgroundPaint>
                <lvc:CartesianChart.TooltipTextPaint>
                    <lvc:SolidColorPaint Color="#333333" />
                </lvc:CartesianChart.TooltipTextPaint>
                
                <!--
                    Minimal point-highlighting: the ChartViewModel exposes
                    IsPointHighlighted(seriesName, index). LiveCharts does not
                    support per-point templates directly in XAML bindings, but
                    raising PropertyChanged for Series when selection changes
                    allows the chart to be redrawn with any style changes that
                    may be applied in code. The visual differentiation itself is
                    kept subtle and is implemented in ChartViewModel by adjusting
                    GeometrySize/GeometryFill for highlighted points when the
                    highlighted index map changes.
                -->
            </lvc:CartesianChart>
            
            <!-- Title Overlay -->
            <TextBlock Text="{Binding Title}"
                       Grid.Row="0"
                       Panel.ZIndex="2"
                       FontSize="16"
                       FontWeight="SemiBold"
                       Foreground="Gray"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Top"
                       Margin="0,20,0,0"
                       IsHitTestVisible="False"/>
        </Grid>
        
        <!-- Legend -->
        <ItemsControl ItemsSource="{Binding LegendItems}"
                      Grid.Row="1"
                      Margin="10,5,10,10">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel HorizontalAlignment="Center" Orientation="Horizontal"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:LegendItem">
                    <StackPanel Orientation="Horizontal" Margin="10,2">
                        <!-- Legend line indicator -->
                        <Canvas Width="30" Height="16" VerticalAlignment="Center">
                            <!-- Solid line (for non-dashed, non-dotted torque curves) -->
                            <Rectangle Canvas.Left="0" Canvas.Top="7" Width="30" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}">
                                <Rectangle.IsVisible>
                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                        <Binding Path="!IsDashed"/>
                                        <Binding Path="!IsDotted"/>
                                    </MultiBinding>
                                </Rectangle.IsVisible>
                            </Rectangle>
                            <!-- Dashed line (for reference lines like Motor Rated Speed, Voltage Max Speed, Brake Torque) -->
                            <Rectangle Canvas.Left="0" Canvas.Top="7" Width="8" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDashed}"/>
                            <Rectangle Canvas.Left="12" Canvas.Top="7" Width="8" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDashed}"/>
                            <Rectangle Canvas.Left="24" Canvas.Top="7" Width="6" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDashed}"/>
                            <!-- Dotted line (for power curves) -->
                            <Rectangle Canvas.Left="0" Canvas.Top="7" Width="3" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDotted}"/>
                            <Rectangle Canvas.Left="6" Canvas.Top="7" Width="3" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDotted}"/>
                            <Rectangle Canvas.Left="12" Canvas.Top="7" Width="3" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDotted}"/>
                            <Rectangle Canvas.Left="18" Canvas.Top="7" Width="3" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDotted}"/>
                            <Rectangle Canvas.Left="24" Canvas.Top="7" Width="3" Height="2"
                                      Fill="{Binding Color, Converter={StaticResource ColorConverter}}"
                                      IsVisible="{Binding IsDotted}"/>
                        </Canvas>
                        <!-- Legend text -->
                        <TextBlock Text="{Binding Name}"
                                   FontSize="12"
                                   VerticalAlignment="Center"
                                   Margin="5,0,0,0"/>
                    </StackPanel>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </Grid>
</UserControl>
